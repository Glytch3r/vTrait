

--[[■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
░░▓██████▓░░░░▓█▓░░░░▓█▓░░░░▓█▓░░▓███████▓░░░▓██████▓░░░░▓█▓░░░░░▓█▓░░░▓███████▓░░░▓███████▓░░
░▓█▓░░░░▓█▓░░░▓█▓░░░░▓█▓░░░░▓█▓░░░░░▓█▓░░░░░▓█▓░░░░▓█▓░░░▓█▓░░░░░▓█▓░░▓█░░░░░░▓█▓░░▓█░░░░░░▓█░
░▓█▓░░░░░░░░░░▓█▓░░░░▓█▓░░░░▓█▓░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░▓█░░░░░░▓█░
░▓█▓░░▓███▓░░░▓█▓░░░░░▓██████▓░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█████████▓░░░░░░▓███▓░░░░▓███████▓░░
░▓█▓░░░░▓█▓░░░▓█▓░░░░░░░▓█▓░░░░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░▓█▓░░░░░█▓░
░▓█▓░░░░▓█▓░░░▓█▓░░░░░░░▓█▓░░░░░░░░░▓█▓░░░░░▓█▓░░░░▓█▓░░░▓█▓░░░░░▓█▓░░▓█░░░░░░▓█▓░░▓█▓░░░░░██░
░░▓██████▓░░░░▓██████░░░▓█▓░░░░░░░░░▓█▓░░░░░░▓██████▓░░░░▓█▓░░░░░▓█▓░░░▓███████▓░░░▓█▓░░░░░██░
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■--]]

  --[[ ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
  ╣ □□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□ ╠  
  ╣                  Custom  PZ  Mod  Developer  for  Hire                     ╠  
  ╣ ◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦◦╠  
  ╣    ► Discord:   glytch3r                                                   ╠   
  ╣    ► Portfolio: https://steamcommunity.com/id/glytch3r/myworkshopfiles/    ╠  
  ╣    ► Support:   https://ko-fi.com/glytch3r                                 ╠  
  ╣    ► Youtube:   https://www.youtube.com/@glytch3r                          ╠  
    ╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳╳ --]] 

--[[◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙
░░▓██████▓░░░░▓██████░░░▓█▓░░░░░░░░░▓█▓░░░░░░▓██████▓░░░░▓█▓░░░░░▓█▓░░░▓███████▓░░░▓█▓░░░░░██░
░▓█▓░░░░▓█▓░░░▓█▓░░░░░░░▓█▓░░░░░░░░░▓█▓░░░░░▓█▓░░░░▓█▓░░░▓█▓░░░░░▓█▓░░▓█░░░░░░▓█▓░░▓█▓░░░░░██░
░▓█▓░░░░▓█▓░░░▓█▓░░░░░░░▓█▓░░░░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░▓█▓░░░░░█▓░
░▓█▓░░▓███▓░░░▓█▓░░░░░▓██████▓░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█████████▓░░░░░░▓███▓░░░░▓███████▓░░
░▓█▓░░░░░░░░░░▓█▓░░░░▓█▓░░░░▓█▓░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░░░░▓█▓░░░░░░░░░░▓█▓░░▓█░░░░░░▓█░
░▓█▓░░░░▓█▓░░░▓█▓░░░░▓█▓░░░░▓█▓░░░░░▓█▓░░░░░▓█▓░░░░▓█▓░░░▓█▓░░░░░▓█▓░░▓█░░░░░░▓█▓░░▓█░░░░░░▓█░
░░▓██████▓░░░░▓█▓░░░░▓█▓░░░░▓█▓░░▓███████▓░░░▓██████▓░░░░▓█▓░░░░░▓█▓░░░▓███████▓░░░▓███████▓░░
◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙◙--]]


vTrait = vTrait or {}

function vTrait.isDay()
    return forageSystem.getTimeOfDay() == 'isDay'
end

function vTrait.isNight()
    return forageSystem.getTimeOfDay() == 'isNight'
end

function vTrait.getCarProtected(targ)
    return SandboxVars.vTrait.CarProtect and targ:getVehicle() ~= nil
end

function vTrait.isShouldBurn(targ)
    if not (targ and targ:isAlive() and targ:HasTrait("V")) then return false end
    if not vTrait.isDay() or RainManager:isRaining() then return false end
    local csq = targ:getCurrentSquare()
    return csq and csq:isOutside() and not csq:haveRoofFull()
end

function vTrait.getSmokeColor(index, alpha)
    local colors = {
        ColorInfo.new(0.5, 0.5, 0.5, alpha),  --1 gray
        ColorInfo.new(1, 0, 0, alpha),        --2 red
        ColorInfo.new(0, 1, 0, alpha),        --3 green
        ColorInfo.new(0, 0, 1, alpha),        --4 blue
        ColorInfo.new(1, 1, 0, alpha),        --5 yellow
        ColorInfo.new(0.5, 0, 0.5, alpha),    --6 purple
        ColorInfo.new(0, 0, 0, alpha),        --7 black
        ColorInfo.new(1, 1, 1, alpha),        --8 white
                                              --9 disabled
    }
    return colors[index] or nil 
end


function vTrait.setDamage(targ, shouldReduce)
    local spr = targ:getAttachedAnimSprite()
    local CarProtected = vTrait.getCarProtected(targ)
    if vTrait.isShouldBurn(targ) and not CarProtected then
        local SunDamage = SandboxVars.vTrait.SunDamage or 0.001
        if shouldReduce then
            local UmbrellaDmgReduction = SandboxVars.vTrait.UmbrellaDmgReduction or 50
            local reduction = (UmbrellaDmgReduction / 100)  
            SunDamage = SunDamage * reduction 
        end
        targ:getBodyDamage():ReduceGeneralHealth(SunDamage)
    end
end

vTrait.col1 = SandboxVars.vTrait.SmokeColor1
vTrait.col2 = SandboxVars.vTrait.SmokeColor2
function vTrait.setSmoke(targ, shouldReduce)
    local spr = targ:getAttachedAnimSprite()
    local CarProtected = vTrait.getCarProtected(targ)
    if vTrait.isShouldBurn(targ) and not CarProtected then
        local UmbrellaDmgReduction = SandboxVars.vTrait.UmbrellaDmgReduction or 50
        local alpha1 = SandboxVars.vTrait.SmokeOpacity1 or 0.05
        local alpha2 = SandboxVars.vTrait.SmokeOpacity2 or 0.007

        if shouldReduce then
            local reduction = (UmbrellaDmgReduction / 100)
            alpha1, alpha2 = alpha1 * reduction, alpha2 * reduction
        end
        
        if vTrait.col1 ~= SandboxVars.vTrait.SmokeColor1 or vTrait.col2 ~= SandboxVars.vTrait.SmokeColor2 then
            targ:RemoveAttachedAnims()
            targ:clearAttachedAnimSprite()
            spr = targ:getAttachedAnimSprite()
        end

        if not spr or spr:size() <= 0 then
            vTrait.col1 = SandboxVars.vTrait.SmokeColor1
            if vTrait.col1 ~= 9 then
                targ:AttachAnim("Smoke", "01", 2, 0.2, 0, 270, true, 0, false, 0, vTrait.getSmokeColor(vTrait.col1, alpha1))
            end

            vTrait.col2 = SandboxVars.vTrait.SmokeColor2
            if vTrait.col2 ~= 9 then
                targ:AttachAnim("Smoke", "01", 6, 0.05, 0, 260, true, 0, false, 0, vTrait.getSmokeColor(vTrait.col2, alpha2))
            end

            spr = targ:getAttachedAnimSprite()
            if spr:size() > 0 then spr:get(0):setScale(1, 0.8) end
            if spr:size() > 1 then spr:get(1):setScale(0.8, 1) end
        end
    elseif spr and spr:size() > 0 then
        targ:RemoveAttachedAnims()
        targ:clearAttachedAnimSprite()
    end
end


function vTrait.PenaltyHandler()
    local targ = getPlayer()
    if targ and targ:isAlive() and targ:HasTrait("V") then
        local pr = targ:getPrimaryHandItem()
        local sc =  targ:getSecondaryHandItem()             
        local shouldReduce = (pr and pr:isProtectFromRainWhileEquipped()) or (sc and sc:isProtectFromRainWhileEquipped())
        vTrait.setDamage(targ, shouldReduce)
        vTrait.setSmoke(targ, shouldReduce)
    end
end
Events.OnPlayerUpdate.Add(vTrait.PenaltyHandler)
